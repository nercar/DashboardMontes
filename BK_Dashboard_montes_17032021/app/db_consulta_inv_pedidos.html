<style>
	.minibadge {
		color:#1f2d3d;
		background-color:#ffc107;
		padding-top: .05em;
		padding-bottom: .05em;
		padding-left: .4em;
		padding-right: .4em;
		font-size:60%;
		letter-spacing: -0.1px;
		line-height: 0.7em;
		border-radius: .25em;
		border: 1px solid #000;
		margin: 0px;
	}
	.selectSize {
		width: 50px !important;
	}
	.dataTables_filter {
		display: none;
	}
</style>

<!-- Main row -->
<div class="row">
	<!-- Auditoria de Costos -->
	<div class="col-md-12 col-sm-12 mt-2" id="div_tbl_datos">
		<div class="card card-primary m-0 p-0 elevation-2 border border-dark">
			<div class="card-header d-flex p-1 pl-2 mb-1 align-items-baseline">
				<i class="fas fa-file-alt"></i>&nbsp;
				<span id="ttitulo">Solicitud de Artículos al Centro de Distribución</span>
				<select id="select_tiendas" class="form-control form-control-sm col-2 ml-3"></select>
				<button class="btn btn-success btn-sm ml-3" id="consultarinv" disabled onclick="consultaInvpedidos()">
					<i class="fas fa-search"></i> Consultar
				</button>
				<button class="btn btn-danger btn-sm ml-3" onclick="limpiarFiltros()">
					<i class="fas fa-broom"></i> Limpiar
				</button>
				<button id="addPedido" class="btn btn-warning btn-sm d-none ml-3">
					<i class="fas fa-check"></i> Procesar
				</button>
				<button id="rapPedido" class="btn btn-warning btn-sm ml-auto d-none">
					<i class="fas fa-bolt"></i> Rapi-Pedido
				</button>
			</div>
			<div class="row p-0 pl-1 pr-1 pb-1">
				<div class="col-2 d-none m-0 p-0">
					<form action="" onsubmit="return false;">
						<div class="bg-dark-gradient text-center">Opciones de la Consulta</div>
						<label class="m-0 mt-1 p-0" for="fprov">Proveedor</label>
						<div class="d-flex">
							<input style="display: none;" placeholder="Nombre Parcial">
							<input type="text" id="fprov" size="20"
								onkeydown="
									onKeyUp(event, this.id);											
									if(this.value=='') {
										$('#nom_prov').html('');
										$('#nom_prov').attr('title', '');
										$('#nom_prov').addClass('d-none');
									}" placeholder="Nombre Parcial" class="m-0 p-0 w-100">
							<button class="btn btn-info btn-sm pt-0 pb-0 m-0" onclick="listaProvBDES()">
								<i class="fas fa-search"></i>
							</button>
							<span id="nom_prov" class="minibadge d-none" title=''></span>
						</div>

						<label class="m-0 mt-1 p-0" for="select_dptos">Departamento</label>
						<div class="d-flex">
							<select id="select_dptos" class="form-control form-control-sm p-0"></select>
						</div>

						<label class="m-0 mt-1 p-0" for="fgrupo">Grupo de Artículo</label>
						<div class="d-flex">
							<input style="display: none;" placeholder="Nombre Grupo">
							<input type="text" id="fgrupo" size="20"
								onkeydown="
									onKeyUp(event, this.id)
									if(this.value=='') {
										$('#nom_grupo').html('');
										$('#nom_grupo').attr('title', '');
										$('#nom_grupo').addClass('d-none');
									}" placeholder="Nombre Grupo" class="m-0 p-0 w-100">
							<button class="btn btn-info btn-sm pt-0 pb-0 m-0" onclick="listaGrupBDES()">
								<i class="fas fa-search"></i>
							</button>
							<span id="nom_grupo" class="minibadge d-none" title=''></span>
						</div>

						<label class="m-0 mt-1 p-0" for="fgrupo">Sub-Grupo Artículo</label>
						<div class="d-flex">
							<input style="display: none;" placeholder="Nombre Sub-Grupo">
							<input type="text" id="fsubgrupo" size="20"
								onkeydown="
									onKeyUp(event, this.id)
									if(this.value=='') {
										$('#nom_subgrupo').html('');
										$('#nom_subgrupo').attr('title', '');
										$('#nom_subgrupo').addClass('d-none');
									}" placeholder="Nombre Sub-Grupo" class="m-0 p-0 w-100" value="">
							<button class="btn btn-info btn-sm pt-0 pb-0 m-0" onclick="listaSubgBDES()">
								<i class="fas fa-search"></i>
							</button>
							<span id="nom_subgrupo" class="minibadge d-none" title=''></span>
						</div>

						<label class="m-0 mt-1 p-0" for="fmaterial">Material/Artículo</label>
						<div class="d-flex">
							<input style="display: none;" placeholder="Nombre Artículo">
							<input type="text" id="fmaterial" size="20"
								onkeydown="
									onKeyUp(event, this.id)
									if(this.value=='') {
										$('#nom_material').html('');
										$('#nom_material').attr('title', '');
										$('#nom_material').addClass('d-none');
									}" placeholder="Nombre Artículo" class="p-0 m-0 w-100" value="">
							<button class="btn btn-info btn-sm pt-0 pb-0 m-0" onclick="listaArticulosBDES()">
								<i class="fas fa-search"></i>
							</button>
							<span id="nom_material" class="minibadge d-none" title=''></span>
						</div>

						<div id="tienda" class="d-none">
							<label class="m-0 mt-1 p-0" for="select_tiendas">Localidad</label>
							<div class="d-flex">
								<select id="select_tiendas" class="form-control form-control-sm p-0"></select>
							</div>
						</div>

						<div class="custom-control custom-checkbox mt-1">
							<input type="checkbox" class="custom-control-input" checked style="cursor: pointer;" id="cajabultos">
							<label class="custom-control-label font-weight-normal" style="cursor: pointer;" for="cajabultos">Ver Cajas/Bultos</label>
						</div>
					</form>
				</div>
				<div class="col-12 table-responsive">
					<div class="d-flex w-100 align-baseline">
						<table class="w-100 table-bordered">
							<tr class="bg-dark text-center">
								<th rowspan="2">Buscar por:</th>
								<th>Barra</th>
								<th>Proveedor</th>
								<th>Departamento</th>
								<th>Artículos</th>
							</tr>
							<tr>
								<td>
									<input type="text" style="display: none;" placeholder="Buscar Barra">
									<input type="text" class="form-control form-control-sm m-0 p-1"
									id="buscarbarr" value="" placeholder="Buscar Barra">
								</td>
								<td>
									<input type="text" style="display: none;" placeholder="Buscar Proveedor">
									<input type="text" class="form-control form-control-sm m-0 p-1"
									id="buscarprov" value="" placeholder="Buscar Proveedor">
								</td>
								<td>
									<input type="text" style="display: none;" placeholder="Buscar Departamento">
									<input type="text" class="form-control form-control-sm m-0 p-1"
									id="buscardpto" value="" placeholder="Buscar Departamento">
								</td>
								<td>
									<input type="text" style="display: none;" placeholder="Buscar Artículo">
									<input type="text" class="form-control form-control-sm m-0 p-1"
									id="buscararti" value="" placeholder="Buscar Artículo">
								</td>
							</tr>
						</table>
					</div>
					<form action="" onsubmit="return false;" class="p-0 m-0" id="frmpedidos">
						<table id="tbl_consultaInvPedidos" class="table table-striped table-hover table-bordered w-100" style="font-size: 95%">
							<thead>
								<tr>
									<th colspan="5" class="text-center txtcomp p-0 m-0 bg-secondary-gradient"></th>
									<th colspan="2" class="text-center txtcomp p-0 m-0 bg-info-gradient">Inventario Cedim</th>
									<th colspan="2" class="text-center txtcomp p-0 m-0 bg-warning-gradient">Inventario Local</th>
									<th colspan="2" class="text-center txtcomp p-0 m-0 bg-primary-gradient">Rotación</th>
									<th colspan="2" class="text-center txtcomp p-0 m-0 bg-success-gradient">Apartado</th>
									<th colspan="2" class="text-center txtcomp p-0 m-0 bg-danger-gradient">Inventario Disponible</th>
									<th colspan="2" class="text-center txtcomp p-0 m-0 bg-light-gradient">Pedido</th>
								</tr>
								<tr>
									<th class="text-center txtcomp p-0 m-0 bg-warning-gradient">Barra</th>
									<th class="text-center txtcomp p-0 m-0 bg-warning-gradient">Proveedor</th>
									<th class="text-center txtcomp p-0 m-0 bg-warning-gradient d-none"></th>
									<th class="text-center txtcomp p-0 m-0 bg-warning-gradient">Descripción</th>
									<th class="text-center txtcomp p-0 m-0 bg-warning-gradient">Empaque</th>
									<th class="text-center txtcomp p-0 m-0 bg-info-gradient">Und.</th>
									<th class="text-center txtcomp p-0 m-0 bg-info-gradient">C/B</th>
									<th class="text-center txtcomp p-0 m-0 bg-warning-gradient">Und.</th>
									<th class="text-center txtcomp p-0 m-0 bg-warning-gradient">C/B</th>
									<th class="text-center txtcomp p-0 m-0 bg-primary-gradient"
										title="La cantidad vendida ayer">Ayer</th>
									<th class="text-center txtcomp p-0 m-0 bg-primary-gradient"
										title="La cantidad en los últimos 7 días">7días</th>
									<th class="text-center txtcomp p-0 m-0 bg-success-gradient">Und.</th>
									<th class="text-center txtcomp p-0 m-0 bg-success-gradient">C/B</th>
									<th class="text-center txtcomp p-0 m-0 bg-danger-gradient">Und.</th>
									<th class="text-center txtcomp p-0 m-0 bg-danger-gradient">C/B</th>
									<th class="text-center txtcomp p-0 m-0 bg-light-gradient">Und.</th>
									<th class="text-center txtcomp p-0 m-0 bg-light-gradient">C/B</th>
								</tr>
							</thead>
						</table>
					</form>
				</div>
			</div>
			<!-- /.card-body -->
		</div>
	</div>
	<!-- /.col -->
</div>
<!-- /.row (main row 2) -->

<!-- Modal Detalle del Pedido -->
<div class="modal fade" id="VerPedido" style="z-index: 9888;" tabindex="-1" role="dialog" aria-labelledby="VerPedidoLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-centered">
		<!-- Modal content-->
		<div class="modal-content">
			<div class="modal-header bg-primary pt-1 pb-1">
				<h4 class="modal-title">Detalle del Pedido</h4>
			</div>
			<div class="modal-body p-0" id="contVerPedido">
				<form action="" onsubmit="return false;" class="form-inline col-12 p-0 m-0 mt-2">
					<div class="d-flex w-100 align-content-center justify-content-center ml-2 mr-2">
						<span class="col-1 font-weight-bold">Buscar: </span>
						<input type="text" class="form-control form-control-sm m-0 ml-1 mr-l p-1 col-11" id="buscarVerPedido" value=""
							placeholder="Buscar Artículo en la Lista...">
					</div>
				</form>
				<form action="" onsubmit="return false;" class="p-1 m-0" id="frmlstartp">
					<table id="tbl_ListaArticulos" class="w-100 table table-striped table-hover table-bordered">
						<thead>
							<tr>
								<th width="10%" class="txtcomp text-center bg-warning-gradient">Barra</th>
								<th width="20%" class="txtcomp text-center bg-warning-gradient">Proveedor</th>
								<th width="40%" class="txtcomp text-center bg-warning-gradient">Descripción</th>
								<th width="10%" class="txtcomp text-center bg-warning-gradient">Und</th>
								<th width="10%" class="txtcomp text-center bg-warning-gradient">C/B</th>
							</tr>
						</thead>
						<tbody></tbody>
						<tfoot>
							<tr>
								<th colspan="2" class="text-center bg-dark-gradient"></th>
								<th class="text-right  bg-dark-gradient"></th>
								<th class="text-right bg-dark-gradient"></th>
								<th class="text-right bg-dark-gradient"></th>
							</tr>
						</tfoot>
					</table>
					<div class="form-group d-flex w-100">
						<button id="savPedido" class="btn btn-outline-success btn-sm mr-auto">
							<i class="fas fa-check"></i> Generar Pedido
						</button>
						<button class="btn btn-primary btn-sm ml-auto" data-dismiss="modal" aria-label="Close">
							<i class="fas fa-times-circle"></i> Continuar Agregando Artículos
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- Modal Pedidos Rápidos -->
<div class="modal fade" id="TblrapPedido" style="z-index: 9888;" tabindex="-1" role="dialog" aria-labelledby="TblrapPedidoLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-centered">
		<!-- Modal content-->
		<div class="modal-content">
			<div class="modal-header bg-primary pt-1 pb-1">
				<h4 class="modal-title">Elaborar Pedido de Forma Rápida</h4>
			</div>
			<div class="modal-body p-1" id="contTblrapPedido">
				<form action="" onsubmit="return false;" class="p-0 m-0 mt-2 mb-2">
					<table align="center" width="70%" border="1px solid;">
						<tr>
							<th class="text-center alert-secondary">Artículo</th>
							<td colspan="9">
								<input type="text" class="form-control form-control-sm"
									placeholder="Buscar Artículo por Código/Barra/Descripción"
									id="buscarTblrapPedido" value="" >
								<input type="hidden" id="empaque" value="12">
							</td>
						</tr>
						<tr>
							<th class="text-center alert-secondary" colspan="2">Local</th>
							<th class="text-center alert-secondary" colspan="2">Apartado</th>
							<th class="text-center alert-secondary" colspan="2">CEDIM</th>
							<th class="text-center alert-secondary" colspan="2">Disponible</th>
							<th class="text-center alert-secondary" colspan="2">Pedido</th>
						</tr>
						<tr>							
							<th class="text-center alert-secondary">Und</th>
							<th class="text-center alert-secondary">C/B</th>
							<th class="text-center alert-secondary">Und</th>
							<th class="text-center alert-secondary">C/B</th>
							<th class="text-center alert-secondary">Und</th>
							<th class="text-center alert-secondary">C/B</th>
							<th class="text-center alert-secondary">Und</th>
							<th class="text-center alert-secondary">C/B</th>
							<th class="text-center alert-secondary">Und</th>
							<th class="text-center alert-secondary">C/B</th>
						</tr>
						<tr>
							<td class="text-center">
								<input type="text" readonly disabled id="locunPED"
									value="10" class="p-0 m-0 text-center selectSize bg-transparent border-0">
							</td>
							<td class="text-center">
								<input type="text" readonly disabled id="loccbPED"
									value="10" class="p-0 m-0 text-center selectSize bg-transparent border-0">
							</td>
							<td class="text-center">
								<input type="text" readonly disabled id="apaunPED"
									value="10" class="p-0 m-0 text-center selectSize bg-transparent border-0">
							</td>
							<td class="text-center">
								<input type="text" readonly disabled id="apacbPED"
									value="10" class="p-0 m-0 text-center selectSize bg-transparent border-0">
							</td>
							<td class="text-center">
								<input type="text" readonly disabled id="cedunPED"
									value="10" class="p-0 m-0 text-center selectSize bg-transparent border-0">
							</td>
							<td class="text-center">
								<input type="text" readonly disabled id="cedcbPED"
									value="10" class="p-0 m-0 text-center selectSize bg-transparent border-0">
							</td>
							<td class="text-center">
								<input type="text" readonly disabled id="disunPED"
									value="10" class="p-0 m-0 text-center selectSize bg-transparent border-0">
							</td>
							<td class="text-center">
								<input type="text" readonly disabled id="discbPED"
									value="10" class="p-0 m-0 text-center selectSize bg-transparent border-0">
							</td>
							<td class="text-center">
								<input type = "number" min = "0" max = "48"
									onblur = "if($(this).val()==0) { $(this).val([]); $('#inpbulPED').val([]) }"
									onkeyup="if ($(this).val()>$('#disunPED').val()) {
											$(this).val( ($('#disunPED').val()<0?null:$('#disunPED').val()) ); 
										};
										convCant($(this).val(), 'PED', 1, $('#empaque').val())"
									onchange="convCant($(this).val(), 'PED', 1, $('#empaque').val())"
									id="inpundPED"
									value="" class="p-0 m-0 text-center selectSize">
							</td>
							<td class="text-center">
								<input type = "number" min = "0" max = "48"
									onblur = "if($(this).val()==0) { $(this).val([]); $('#inpundPED').val([]) }"
									onkeyup="if ($(this).val()>$('#discbPED').val()) {
											$(this).val( ($('#discbPED').val()<0?null:$('#discbPED').val()) ); 
										};
										convCant($(this).val(), 'PED', 2, $('#empaque').val())"
									onchange="convCant($(this).val(), 'PED', 2, $('#empaque').val())"
									id="inpbulPED"
									value="" class="p-0 m-0 text-center selectSize">
							</td>
						</tr>
					</table>
				</form>
				<form action="" onsubmit="return false;" class="p-0 m-0" id="frmlstped">
					<table id="tbl_ListaArticulosRP" class="w-100 table table-striped table-hover table-bordered">
						<thead>
							<tr>
								<th width="10%" class="txtcomp text-center bg-warning-gradient">Código</th>
								<th width="15%" class="txtcomp text-center bg-warning-gradient">Barra</th>
								<th width="40%" class="txtcomp text-center bg-warning-gradient">Descripción</th>
								<th width="5%"  class="txtcomp text-center bg-warning-gradient">Apartado</th>
								<th width="5%"  class="txtcomp text-center bg-warning-gradient">Exist. Local</th>
								<th width="5%"  class="txtcomp text-center bg-warning-gradient">Exist. CEDIM</th>
								<th width="5%"  class="txtcomp text-center bg-warning-gradient">Unidades</th>
								<th width="5%"  class="txtcomp text-center bg-warning-gradient">Bultos</th>
							</tr>
						</thead>
					</table>
				</form>
			</div>
			<div class="modal-footer pt-2 pb-2 align-items-end justify-content-end align-top">
				<div class="text-center col-9 rounded border border-dark elevation-2 d-none" id="msj"></div>
				<button class="btn btn-outline-danger col-3" class="close" data-dismiss="modal" id="btncerrar">
					Cerrar <i class="fas fa-times-circle"></i>
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Modal lista de articulos -->
<div class="modal fade" id="TblArt" style="z-index: 9890;" tabindex="-1" role="dialog" aria-labelledby="TblArtLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<!-- Modal content-->
		<div class="modal-content">
			<div class="modal-header bg-primary pt-1 pb-1">
				<h4 class="modal-title">Seleccione un Artículo</h4>
				<button type="button" data-dismiss="modal" aria-label="Close" class="btn btn-danger btn-lg float-right">
					<span class="fas fa-window-close float-right" aria-hidden="true"></span>
				</button>
			</div>
			<div class="modal-body p-0" id="contTblArt">
				<form action="" onsubmit="return false;" class="p-0 m-0" id="frmlstart">
					<table id="tlstArticulos" class="w-100 table table-striped table-hover table-bordered">
						<thead>
							<tr>
								<th width="10%" class="txtcomp text-center bg-warning-gradient">Código</th>
								<th width="10%" class="txtcomp text-center bg-warning-gradient">Barra</th>
								<th width="60%" class="txtcomp text-center bg-warning-gradient">Descripción</th>
								<th width="10%" class="txtcomp text-center bg-warning-gradient">Apartado</th>
								<th width="10%" class="txtcomp text-center bg-warning-gradient">Exist. CEDIM</th>
							</tr>
						</thead>
					</table>
				</form>
			</div>
			<div class="modal-footer pt-2 pb-2 align-items-end justify-content-end align-top">
				<button class="btn btn-outline-danger col-3" class="close" data-dismiss="modal" id="btncerrar">
					Cerrar <i class="fas fa-times-circle"></i>
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Modal Rotacion Articulos Localidad -->
<div class="modal fade" id="VerRot" style="z-index: 9890;" tabindex="-1" role="dialog" aria-labelledby="VerRotLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<!-- Modal content-->
		<div class="modal-content">
			<div class="modal-header bg-primary pt-1 pb-1">
				<h4 class="modal-title">Rotación del Artículo en la Tienda <span id="rtienda"></span></h4>
				<button type="button" data-dismiss="modal" aria-label="Close" class="btn btn-danger btn-lg float-right">
					<span class="fas fa-window-close float-right" aria-hidden="true"></span>
				</button>
			</div>
			<div class="modal-body p-1" id="contVerRot">
				<table class="table-bordered w-100" id="tblRot">
					<tr>
						<th width="20%" class="text-center bg-warning-gradient p-1">Artículo</th>
						<th class="text-center bg-warning-gradient p-1" colspan="6">Descripción del Artículo</th>
					</tr>
					<tr>
						<td><span id="rcodigo"></span></td>
						<td colspan="6"><span id="rdesc"></span></td>
					</tr>
					<tr>
						<th class="text-center bg-warning-gradient p-1" colspan="7">Información de la Rotación de Venta del Artículo</th>
					</tr>
					<tr>
						<th class="text-right" colspan="4">Fecha de la Última Venta:</th>
						<td colspan="3"><span id="rfecha"></span></td>
					</tr>
					<tr>
						<th class="text-center bg-warning-gradient p-1" colspan="7">Cantidades Vendidas</th>
					</tr>
					<tr>
						<th class="text-center alert-primary" rowspan="2">Venta<br><span class="pl-1 pr-1 text-center rounded border border-dark bg-warning-gradient">&nbsp;1&nbsp;</span>&nbsp;Entre Fechas <i class="fas fa-angle-double-right"></i></th>
						<th class="text-center alert-primary">Ayer</th>
						<th class="text-center alert-primary">7 días</th>
						<th class="text-center alert-primary">15 días</th>
						<th class="text-center alert-primary">30 días</th>
						<th class="text-center alert-primary">45 días</th>
						<th class="text-center alert-primary">60 días</th>
					</tr>
					<tr>
						<!-- <th class="text-center alert-primary">Entre Fechas <i class="fas fa-angle-double-right"></i></th> -->
						<td class="text-center"><span id="rayer"  ></span></td>
						<td class="text-center"><span id="rd7dias" ></span></td>
						<td class="text-center"><span id="rd15dias"></span></td>
						<td class="text-center"><span id="rd30dias"></span></td>
						<td class="text-center"><span id="rd45dias"></span></td>
						<td class="text-center"><span id="rd60dias"></span></td>
					</tr>
					<tr>
						<th class="text-right alert-primary" colspan="2">
							Suma <i class="fas fa-angle-double-right"></i>
						</th>
						<td class="text-center"><span id="r7dias" ></span></td>
						<td class="text-center"><span id="r15dias"></span></td>
						<td class="text-center"><span id="r30dias"></span></td>
						<td class="text-center"><span id="r45dias"></span></td>
						<td class="text-center"><span id="r60dias"></span></td>
					</tr>
					<tr>
						<th class="text-right alert-primary" colspan="2"><span class="pl-1 pr-1 text-center rounded border border-dark bg-primary-gradient">&nbsp;2&nbsp;</span>&nbsp;Rango de días</th>
						<th class="text-center alert-primary">7</th>
						<th class="text-center alert-primary">7</th>
						<th class="text-center alert-primary">15</th>
						<th class="text-center alert-primary">15</th>
						<th class="text-center alert-primary">15</th>
					</tr>
					<tr>
						<th class="text-right alert-primary" colspan="2">
							Promedio <i class="fas fa-angle-double-right"></i> <span class="pl-1 pr-1 text-center rounded border border-dark bg-warning-gradient">&nbsp;1&nbsp;</span>&nbsp;/&nbsp;<span class="pl-1 pr-1 text-center rounded border border-dark bg-primary-gradient">&nbsp;2&nbsp;</span>
						</th>
						<td class="text-center"><span id="rp7dias" ></span></td>
						<td class="text-center"><span id="rp15dias"></span></td>
						<td class="text-center"><span id="rp30dias"></span></td>
						<td class="text-center"><span id="rp45dias"></span></td>
						<td class="text-center"><span id="rp60dias"></span></td>
					</tr>
				</table>
			</div>
		</div>
	</div>
</div>

<!-- hora para el reporte -->
<input type="hidden" id="horah">

<script src="app/js/app.js"></script>

<script>
	var buscarbarr = 0;
	var buscarprov = 0;
	var buscardpto = 0;
	var buscararti = 0;
	$(function() {
		// Se consultan las tiendas activas en el dashboard para seleccionar
		$.ajax({
			data: {
				opcion: "listaTiendasBDES",
				sqlcnx: 1,
				idpara: ptodas + '¬' + ptienda,
			},
			type: "POST",
			dataType: "json",
			url: "app/DBProcs.php",
			success: function(data) {
				$("#select_tiendas").append('<option value="">-- Seleccione Tienda --</option>');
				for (i=0; i<data.length; i++) {
					if(!ptodas && data[i].codigo==parseInt(ptienda)) {
						$("#select_tiendas").append('<option value="'+ data[i].codigo + '" selected title="ID: ' + '[' + String('00'+data[i].codigo).slice(-2) + '] ' + '">' + data[i].nombre + '</option>');
					} else {
						$("#select_tiendas").append('<option value="'+ data[i].codigo + '" title="ID: ' + '[' + String('00'+data[i].codigo).slice(-2) + '] ' + '">' + data[i].nombre + '</option>');
					}
				}
				if(!ptodas) {
					$("#select_tiendas").attr('disabled', 'disabled');
					$('#consultarinv').attr('disabled', false);
				}
			}
		});		

		$('#tbl_consultaInvPedidos').DataTable({ scrollY: "59vh" }).columns.adjust().draw();

		$('.modal').modal({backdrop: 'static', keyboard: false, show: false});
	});

	function tabE(obj,e) { 
		var e=(typeof event!='undefined')?window.event:e;// IE : Moz 
		if(e.keyCode==13){ 
			var ele = document.forms.namedItem('frmpedidos').elements; 
			for(var i=0;i<ele.length;i++) { 
				var q=(i==ele.length-1)?0:i+4;// if last element : if any other 
				if(obj==ele[i]) {
					ele[q].focus();
					break;
				} 
			}
			return false; 
		} 
	} 

	// Para limpiar los campos de filtros
	function limpiarFiltros() {
		// Se recarga la pagina para inicializar todo
		cargarcontenido('consulta_inv_pedidos');
	}

	$("#buscarbarr").keyup(function(e) {
		if(e.which == '13') {
			$('#tbl_consultaInvPedidos').dataTable().fnFilter(this.value, 0);
			buscarbarr = 1;
			$('#tbl_consultaInvPedidos').find('input').first().focus();
		}
		if(this.value=='' && buscarbarr==1) {
			$('#tbl_consultaInvPedidos').dataTable().fnFilter('', 0);
			buscarbarr = 0;
			$('#tbl_consultaInvPedidos').find('input').first().focus();
		}
	});

	$("#buscarprov").keyup(function(e) {
		if(e.which == '13') {
			$('#tbl_consultaInvPedidos').dataTable().fnFilter(this.value, 1);
			buscarprov = 1;
			$('#tbl_consultaInvPedidos').find('input').first().focus();
		}
		if(this.value=='' && buscarprov==1) {
			$('#tbl_consultaInvPedidos').dataTable().fnFilter('', 1);
			buscarprov = 0;
			$('#tbl_consultaInvPedidos').find('input').first().focus();
		}
	});

	$("#buscardpto").keyup(function(e) {
		if(e.which == '13') {
			$('#tbl_consultaInvPedidos').dataTable().fnFilter(this.value, 2);
			buscardpto = 1;
			$('#tbl_consultaInvPedidos').find('input').first().focus();
		}
		if(this.value=='' && buscardpto==1) {
			$('#tbl_consultaInvPedidos').dataTable().fnFilter('', 2);
			buscardpto = 0;
			$('#tbl_consultaInvPedidos').find('input').first().focus();
		}
	});

	$("#buscararti").keyup(function(e) {
		if(e.which == '13') {
			$('#tbl_consultaInvPedidos').dataTable().fnFilter(this.value, 3);
			buscararti = 1;
			$('#tbl_consultaInvPedidos').find('input').first().focus();
		}
		if(this.value=='' && buscararti==1) {
			$('#tbl_consultaInvPedidos').dataTable().fnFilter('', 3);
			buscararti = 0;
			$('#tbl_consultaInvPedidos').find('input').first().focus();
		}
	});

	$('#cajabultos').on('change', function() {
		var table = $('#tbl_consultaInvPedidos').DataTable();
		table.column(5).visible( $('#cajabultos').prop('checked') );
		table.column(7).visible( $('#cajabultos').prop('checked') );
		table.column(9).visible( $('#cajabultos').prop('checked') );
		table.column(11).visible( $('#cajabultos').prop('checked') );
		table.column(13).visible( $('#cajabultos').prop('checked') );
	})

	$('#select_dptos').on('change', function() {
		if(this.value!='*') {
			$('#fgrupo').val('');
			$('#fsubgrupo').val('');
			$('#fmaterial').val('');
		}
	})

	$('#select_tiendas').on('change', function() {
		if($(this).val()=='') {
			$('#consultarinv').attr('disabled', 'disabled');
			$('#sucursal').html('&nbsp;' + 'Todas las Tiendas'  + '&nbsp;');
		} else {
			$('#consultarinv').attr('disabled', false);
			$('#sucursal').html('&nbsp;' + $("#select_tiendas option:selected").text() + '&nbsp;');
		}
	})

	$('#VerPedido').on('shown.bs.modal', function () {
		$('#contVerPedido').css( 'display', 'block' );
		$('#tbl_ListaArticulos').DataTable().columns.adjust().draw();
		$('#buscarVerPedido').focus();
	})
	
	$('#TblrapPedido').on('shown.bs.modal', function () {
		$('#contTblrapPedido').css( 'display', 'block' );
		$('#tbl_ListaArticulosRP').DataTable({ scrollY: "30vh", scrollCollapse: false, }).columns.adjust().draw();
		$('#buscarTblrapPedido').focus();
	})

	$('.modal').on('hidden.bs.modal', function() {
		
		$('.modal-backdrop').css('zIndex', 8888);
	})

	$('#TblArt').on('shown.bs.modal', function () {
		$('#contTblArt').css( 'display', 'block' );
		$('#tlstArticulos').DataTable({ scrollY: "30vh", scrollCollapse: false, }).columns.adjust().draw();
	})

	$("#buscarVerPedido").keyup(function() {
		// Buscar en la tabla
		$('#tbl_ListaArticulos').dataTable().fnFilter( this.value );
	});

	$('#buscarTblrapPedido').keyup(function(e) {
		if(e.which == '13') {
			listaArticulosDispo($(this).val())
		}
	});

	// Para detectar el enter en los input
	function onKeyUp(event, id) {
		var keycode = event.keyCode;
		if(keycode == '13'){
			switch (id) {
				case 'fprov':
					listaProvBDES();
					break;
				case 'fgrupo':
					listaGrupBDES();
					break;
				case 'fsubgrupo':
					listaSubgBDES();
					break;
				case 'fmaterial':
					listaArticulosBDES();
					break;
			}
		}
	}

	// Obtiene la información de los articulos agotados
	function consultaInvpedidos() {
		if(ptodas && $('#select_tiendas').val()=='') {
			alert('Debe Seleccionar una tienda para la consulta');
			$('#select_tiendas').focus();
		} else {
			$("#select_tiendas").attr('disabled', 'disabled');
			cargando('show');
			tomar_datos = $.ajax({
				data: {
					opcion: "consultaInvPedidos",
					idpara: $('#select_tiendas').val(),
					sqlcnx: 1,
				},	
				type: "POST",
				dataType: "json",
				url: "app/DBProcs.php",
				success: function (data) {
					if(data.length>0) { $('#addPedido').removeClass('d-none'); } // Mostrar boton para procesar el pedido en un principio
					$('#tbl_consultaInvPedidos').dataTable({
						scrollY: "57vh",
						scrollCollapse: false,
						order: [ 3, 'asc'],
						data: data,
						searching: true,
						autoWidth: false,
						columns: [
							{ data: "barra",        sClass: "txtcomp m-0 p-0 text-left   align-middle border border-top-0 border-bottom-0" },
							{ data: "proveedor",    sClass: "txtcomp m-0 p-0 text-left   align-middle border border-top-0 border-bottom-0" },
							{ data: "departamento", visible: false },
							{ data: "descripcion",  sClass: "txtcomp m-0 p-0 text-left   align-middle border border-top-0 border-bottom-0" },
							{ data: "empaque",      sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0", orderable: false, render: $.fn.dataTable.render.number(".", "", 0) },
							{ data: "ExistCedim",   sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0", render: $.fn.dataTable.render.number(".", "", 0) },
							{ data: 'cajaCedims',   sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0", render: $.fn.dataTable.render.number(",", ".", 2) },
							{ data: "ExistLocal",   sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0", render: $.fn.dataTable.render.number(".", "", 0) },
							{ data: "cajaLocal",    sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0", render: $.fn.dataTable.render.number(",", ".", 2) },
							{ data: "rotayer",      sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0" },
							{ data: "rot7dia",      sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0" },
							{ data: 'apartado',     sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0", render: $.fn.dataTable.render.number(".", "", 0) },
							{ data: 'cajaApart',    sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0", render: $.fn.dataTable.render.number(",", ".", 2) },
							{ data: 'invDisp',      sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0", render: $.fn.dataTable.render.number(".", "", 0) },
							{ data: 'cajaDisp',     sClass: "txtcomp m-0 p-0 text-right align-middle border border-top-0 border-bottom-0", render: $.fn.dataTable.render.number(",", ".", 2) },
							{ data: null, orderable: false,
								render: function(data,type,row,meta){
									return	'<input type = "number" min = "0" max = "' + data.invDisp + '"' +
											' onblur = "if($(this).val()==0) { $(this).val([]); $(\'#inpbul'+data.material+'\').val([]) }"' +
											' onkeydown="return tabE(this,event);"' +
											' onkeyup="if ($(this).val()>' + data.invDisp + ') {' + 
											'	$(this).val(' + (data.invDisp<0?null:data.invDisp) +');' + 
											' }; convCant($(this).val(), '+data.material+', 1, '+data.empaque+')"'+
											' onchange="convCant($(this).val(), '+data.material+', 1, '+data.empaque+')"'+
											' data-material = "' + data.material + '"' +
											' data-exicedim = "' + data.ExistCedim + '"' +
											' data-exilocal = "' + data.ExistLocal + '"' +
											' data-empaque = "' + data.empaque + '"' +
											' id="inpund' + data.material + '"' +
											' name="pedido[]" value="" class="p-0 m-0 text-center selectSize">';
								},
								sClass: "txtcomp m-0 p-0 text-left  align-middle border border-top-0 border-bottom-0",
							},
							{ data: null, orderable: false,
								render: function(data,type,row,meta){
									return	'<input type = "number" step="0.01" min = "0" max = "' + data.cajaDisp + '"' +
											' onblur = "if($(this).val()==0) { $(this).val([]); $(\'#inpund'+data.material+'\').val([]) }"' +
											' onkeydown="return tabE(this,event);"' +
											' onkeyup="if ($(this).val()>' + data.cajaDisp + ') {' + 
											'	$(this).val(' + (data.cajaDisp<0?null:data.cajaDisp) +')' + 
											' }; convCant($(this).val(), '+data.material+', 2, '+data.empaque+')"'+
											' onchange="convCant($(this).val(), '+data.material+', 2, '+data.empaque+')"'+
											' data-material = "' + data.material + '"' +
											' data-exicedim = "' + data.cajaCedims + '"' +
											' data-exilocal = "' + data.cajaLocal + '"' +
											' data-empaque = "' + data.empaque + '"' +
											' id="inpbul' + data.material + '"' +
											' value="" class="p-0 m-0 text-center selectSize">';
								},
								sClass: "txtcomp m-0 p-0 text-left  align-middle border border-top-0 border-bottom-0",
							}
						],
						initComplete: function() {
							$('#tbl_consultaInvPedidos').DataTable().columns.adjust().draw();
						}
					});
				} // Fin funcion success
			}).done(function() {
				$('#consultarinv').attr('disabled', 'disabled');
				cargando('hide');
				$('#tbl_consultaInvPedidos').find('input').first().focus();
			}); //Fin de Ajax	
		}
	}; // Fin de Funcion

	$('#rapPedido').click( function() {
		// Muestra la venta para hacer pedido rápido
		$('#TblrapPedido').modal('show');
	})

	$('#savPedido').click( function() {
		$('#VerPedido').modal('hide');
		cargando2('show');
		setTimeout("guaPedido()", 200);
	});

	function guaPedido() {
		$('#tbl_consultaInvPedidos').dataTable().fnFilter('');
		pedido   = [];
		material = [];
		exicedim = [];
		exilocal = [];
		empaque  = [];

		$("input[name='pedido[]']").each(function() {
			if($(this).val() > 0) {
				pedido.push(   $(this).val() );
				material.push( $(this).data('material') );
				exicedim.push( $(this).data('exicedim') );
				exilocal.push( $(this).data('exilocal') );
				empaque.push(  $(this).data('empaque') );
			}
		});

		// Validar si a realizado pedidos
		pedidos = pedido.filter(Boolean);

		if(pedidos != '') {
			var datos = new FormData();
			datos.append('sqlcnx'  , 1);
			datos.append('opcion'  , 'guardarSolicPedi');
			datos.append('tienda'  , $('#select_tiendas').val());
			datos.append('usidnom' , $('#uinombre').val() + ' (' + $('#uilogin').val() + ')');
			datos.append('material', material);
			datos.append('exicedim', exicedim);
			datos.append('exilocal', exilocal);
			datos.append('pedido'  , pedido);
			datos.append('empaque' , empaque);
			$.ajax({
				url: "app/DBProcs.php",
				contentType:false,
				processData:false,
				cache:false,
				data: datos,
				type: "POST",
				dataType: "json",
				success : function(data) {
					data = data.split('¬');
					if (data[0] == 1) { 
						alert(data[1]);
						$('#contenido_ppal').load('app/db_consulta_inv_pedidos.html?t=' + moment().format("HH:mm:ss"));
					}else{
						alert(data[1]);
					}
				}
			}).done(function() { cargando2('hide'); });					
		} else {
			alert('No hay pedidos por procesar');
			setTimeout("$('#tbl_consultaInvPedidos').find('input').first().focus(); cargando2('hide');", 150);
		} 
	};

	$('#addPedido').click( function() {
		cargando2('show');
		setTimeout("prevPedido()", 200);
	});

	function prevPedido() {
		$('#tbl_consultaInvPedidos').dataTable().fnFilterClear();
		var datos = [];
		var table = $('#tbl_consultaInvPedidos').DataTable()
		table.rows().eq(0).each( function ( index ) {
			var row = table.row( index );
			var data = row.data();
			if($('#inpund'+data['material']).val()!='') {
				datos.push({
					'barra'       : data['barra'],
					'proveedor'   : data['proveedor'],
					'descripcion' : data['descripcion'],
					'unidad'      : $('#inpund'+data['material']).val(),
					'cajas'       : $('#inpund'+data['material']).val()/data['empaque']
				})
			}
		});
		$('#tbl_ListaArticulos').dataTable({
			scrollY: "50vh",
			scrollCollapse: false,
			data: datos,
			autoWidth: false,
			searching: true,
			order: [2 , 'asc'],
			columns: [
				{ data: 'barra',       sClass: "txtcomp text-left align-middle"},
				{ data: 'proveedor',   sClass: "txtcomp text-left align-middle"},
				{ data: 'descripcion', sClass: "txtcomp text-left align-middle"},
				{ data: 'unidad',      sClass: "txtcomp text-right align-middle", render: $.fn.dataTable.render.number(",", ".", 2)},
				{ data: 'cajas',       sClass: "txtcomp text-right align-middle", render: $.fn.dataTable.render.number(",", ".", 2)},
			],
			footerCallback: function (row, data, start, end, display) {
				totalp0 = this.api().rows().count();
				totalp3 = this.api()
					.column(3) //numero de columna a sumar
					.data() //obtenemos los datos en la columna
					.reduce(function (a, b) {
						return parseInt(a) + parseInt(b);
					}, 0);
				totalp4 = this.api()
					.column(4) //numero de columna a sumar
					.data() //obtenemos los datos en la columna
					.reduce(function (a, b) {
						return parseFloat(a) + parseFloat(b);
					}, 0);

				$(this.api().column(0).footer()).html((isNaN(totalp0) ? 0 : totalp0).toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,') + ' Artículos Pedidos');
				$(this.api().column(2).footer()).html('Totales');
				$(this.api().column(3).footer()).html((isNaN(totalp3) ? 0 : totalp3).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
				$(this.api().column(4).footer()).html((isNaN(totalp4) ? 0 : totalp4).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
			},
			initComplete: function() {
				cargando2('hide');
				$('#tbl_ListaArticulos').dataTable().fnFilter('');
				$('#VerPedido').modal('show');
			}
		});
	};

	function convCant(valor, id, tipo, empaque) {
		if(valor>0) {
			if(tipo == 1) {
				$("#inpbul"+id).val((valor / empaque).toFixed(2));
			} else {
				$("#inpund"+id).val((empaque * valor).toFixed(0));
			}
		} else {
			$("#inpbul"+id).val(valor);
			$("#inpund"+id).val(valor);
		}		
	}

	function seleccion(campo, codigo, desc) {
		$('#f'+campo).val(codigo);
		$('#nom_'+campo).html(desc.substr(0,20)+'...');
		$('#nom_'+campo).attr('title', desc);
		$('#nom_'+campo).removeClass('d-none');
		$('#ModalDatos2').modal('hide');
	}

	function listaArticulosDispo(material) {
		cargando('show')
		var flag = 0;
		tomar_datos = $.ajax({
			url: "app/DBProcs.php",
			data: {
				opcion: "listaArticulosDispo",
				idpara: material,
				sqlcnx: 1,
			},
			type: "POST",
			dataType: "json",
			success : function(data) {
				if(data.length>0){
					flag = 1
					$('#tlstArticulos').dataTable({
						scrollY: "50vh",
						scrollCollapse: false,
						data: data,
						autoWidth: false,
						searching: true,
						columns: [
							{ data: 'codigo',      sClass: "txtcomp text-left align-middle"},
							{ data: 'barra',       sClass: "txtcomp text-left align-middle"},
							{ data: 'descripcion', sClass: "txtcomp text-left align-middle"},
							{ data: 'apartado',    sClass: "txtcomp text-right align-middle", render: $.fn.dataTable.render.number(",", ".", 2)},
							{ data: 'existcedim',  sClass: "txtcomp text-right align-middle", render: $.fn.dataTable.render.number(",", ".", 2)},
						]
					});
				} else {
					alert('No existe el Artículo o No tiene Existencia en el CEDIM');
					$('#buscarTblrapPedido').focus();
				}
			}
		}).done(function() {
			cargando('hide');
			if(flag==1) {
				$('.modal-backdrop').css('zIndex', 9889);
				$('#tlstArticulos').dataTable().fnFilter('');
				$('#TblArt').modal('show');
			}
		})
	}

	// Agrega un articulo nuevo al listado del pedido
	function agregararticulo(codigo, barra, descripcion, apartado, empaque, existcedim) {
		$('#TblArt').modal('hide');
		var rowNode = 
		$('#tbl_consultaInvPedidosDet').DataTable().row.add({ 
			'codigo': codigo,
			'barra': barra,
			'descripcion': descripcion,
			'empaque': empaque,
			'apartado': apartado,
			'existcedim': (existcedim-apartado).toFixed(0),
			'total_pedidos': 0,
		}).draw( false ).node();

		$(rowNode).css( 'color', 'blue' ).animate( { color: 'green', fontWeight: '900' }, '900' );

		$('#inpund'+codigo).attr('data-existcedim', existcedim);
		$('#inpund'+codigo).attr('data-empaque', empaque);
		$('#inpund'+codigo).attr('data-codigo', codigo);
		$('#inpund'+codigo).attr('data-existlocal', '0');

		$('#inpbul'+codigo).attr('data-existcedim', existcedim);
		$('#inpbul'+codigo).attr('data-empaque', empaque);
		$('#inpbul'+codigo).attr('data-codigo', codigo);
		$('#inpbul'+codigo).attr('data-existlocal', '0');

		$('#inpund'+codigo).focus().select();
	}

	function verDetRotaArtLoc(codigo, localidad) {
		cargando('show');
		tomar_datos = $.ajax({
			url: "app/DBProcs.php",
			data: {
				opcion: "verDetRotaArtLoc",
				idpara: localidad,
				codigo: codigo,
				sqlcnx: 1,
			},
			type: "POST",
			dataType: "json",
			success : function(data) {
				if(data.length>0) {
					data = data[0];
					$('#rcodigo').html(data.material);
					$('#rdesc').html(data.descripcion);
					$('#rfecha').html(data.fecha);
					$('#rayer').html(data.cantayer);
					$('#rd7dias').html(data.dif7dias);
					$('#rd15dias').html(data.dif15dias);
					$('#rd30dias').html(data.dif30dias);
					$('#rd45dias').html(data.dif45dias);
					$('#rd60dias').html(data.dif60dias);
					$('#rp7dias').html(data.prom7dias);
					$('#rp15dias').html(data.prom15dias);
					$('#rp30dias').html(data.prom30dias);
					$('#rp45dias').html(data.prom45dias);
					$('#rp60dias').html(data.prom60dias);
					$('#r7dias').html(data.cant7dias);
					$('#r15dias').html(data.cant15dias);
					$('#r30dias').html(data.cant30dias);
					$('#r45dias').html(data.cant45dias);
					$('#r60dias').html(data.cant60dias);
					$('#rtienda').html($("#select_tiendas option:selected").text());
					$('#VerRot').modal('show');
				} else {
					msg.fire({
						title: '!!! A T E N C I Ó N ¡¡¡',
						icon: 'info',
						html: 'No hay información para mostrar',
						showCancelButton: false,
					})
				}
			}
		}).done(function() {
			cargando('hide');
		});
	}

	jQuery.fn.dataTableExt.oApi.fnFilterClear  = function ( oSettings ) {
		var i, iLen;
	 
		/* Remove global filter */
		oSettings.oPreviousSearch.sSearch = "";
	 
		/* Remove the text of the global filter in the input boxes */
		if ( typeof oSettings.aanFeatures.f != 'undefined' )
		{
			var n = oSettings.aanFeatures.f;
			for ( i=0, iLen=n.length ; i<iLen ; i++ )
			{
				$('input', n[i]).val( '' );
			}
		}
	 
		/* Remove the search text for the column filters - NOTE - if you have input boxes for these
		 * filters, these will need to be reset
		 */
		for ( i=0, iLen=oSettings.aoPreSearchCols.length ; i<iLen ; i++ )
		{
			oSettings.aoPreSearchCols[i].sSearch = "";
		}
	 
		/* Redraw */
		oSettings.oApi._fnReDraw( oSettings );
	};
</script>