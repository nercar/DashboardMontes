<style>
	.required {
		box-shadow: inset 4px 0px rgba(247, 78, 0, 0.479);
	}
	label {
		/* line-height: 0px; */
		white-space: nowrap;
		margin-bottom: 0em;
	}
	.select-sm {
		padding: 0.255em !important;
	}
	.bs-searchbox input {
		padding: 0.1em !important;
		margin: 0em !important;
	}
	.txtcomp2 {
		letter-spacing: -0.8px;
	}
	.dropdown-item:hover small {
		color: whitesmoke !important;
	}
	.dropdown-item small {
		letter-spacing: normal !important;
	}
	[type="date"]::-webkit-calendar-picker-indicator {
  		margin: 2px;
		padding: 0px;
	}
</style>
<!-- Main row -->
<div class="row" id="div_ppal_rc">
	<!-- Lista de Clientes -->
	<div class="col-md-12 col-sm-12 mt-2 d-none" id="rowLista">
		<div class="card card-primary m-0 p-0 elevation-2 border border-dark">
			<div class="card-header d-flex p-1 pl-2 mb-1 align-items-baseline">
				<i class="fas fa-user-edit"></i>&nbsp;Lista de Clientes del Sistema&nbsp;
				<span id="filtroBuscar"></span>
				<div class="btn btn-sm btn-success font-weight-bold ml-auto m-0 p-0 pl-1 pr-1">
					<a onclick="nuevoCliente()"><i class="fas fa-user-plus"></i> Nuevo Cliente</a>
				</div>
			</div>
			<div class="row col-12 card-header-pills">
				<div class="form-group col-12 m-auto">
					<div class="form-inline">
						<label for="buscarClte">Buscar Cliente&nbsp;</label>
						<input type="text" name="buscarClte" id="buscarClte" class="form-control form-control-sm col" autocomplete="off"
							placeholder="Buscar Cliente por Rif/Nombre parcial" onkeyup="if(event.keyCode==13) { buscarCliente() }">
						&nbsp;
						<button class="btn btn-sm btn-primary ml-auto" onclick="buscarCliente()">
							<i class="fa fa-search" aria-hidden="true"></i> Buscar...
						</button>
					</div>
				</div>
			</div>
			<div class="card-body p-1" style="overflow-x: auto; overflow-y: scroll;" id="lstClientes">
				<table id="lstClientesFacEle" class="table-striped table-hover txtcomp2" width="100%" style="font-size: 90%;">
					<thead class="bg-dark-gradient">
						<tr>
							<th class="text-center border border-top-0 border-bottom-0">Cód</th>
							<th class="text-center border border-top-0 border-bottom-0">Rif</th>
							<th class="text-center border border-top-0 border-bottom-0">Nombre</th>
							<th class="text-center border border-top-0 border-bottom-0">Teléfono</th>
							<th class="text-center border border-top-0 border-bottom-0">Correo Electrónico</th>
							<th class="text-center border border-top-0 border-bottom-0">Opciones</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
	</div>
	<!-- Datos de Clientes -->
	<div class="col-md-12 col-sm-12 mt-2 d-none" id="rowDatos">
		<div class="card card-primary m-0 p-0 elevation-2 border border-dark">
			<div class="card-header d-flex p-1 pl-2 mb-1 align-items-baseline">
				<i class="fas fa-user-edit"></i>&nbsp;
				<label class="font-weight-normal">Registro de Clientes - 
					<label class="badge badge-warning p-0 select-sm border border-white elevation-2" id="subtitulo"></label>
				</label>
			</div>
			<div class="card-body p-1" style="overflow-x: auto; overflow-y: scroll;" id="div_datos">
				<div class="form-group txtcomp2" id="frmdatos">
					<div class="row col-12">
						<div class="form-group col-3">
							<input type="hidden" value="" id="codigoclte">
							<label for="idclte">Identificación</label>
							<div class="form-inline">
								<select id="select_idfiscal" class="selectpicker form-control form-control-sm col-3 border required"
									data-size="5" data-style="rounded select-sm bg-transparent"></select>
								<input type="number" id="idclte" class="form-control form-control-sm col-7 required campo"
									maxlength="10" placeholder="Número Identidad"
									oninput="if(this.value.length > this.maxlength) this.value = this.value.slice(0, this.maxlength);">
								<input type="number" id="codverif" class="form-control form-control-sm col-2 campo" maxlength="1"
									oninput="if(this.value.length > this.maxlength) this.value = this.value.slice(0, this.maxlength);">
							</div>
						</div>
						<div class="form-group col-9 d-flex">
							<div class="col-3">
								<label for="select_tipopersona">Tipo Persona</label>
								<select id="select_tipopersona" class="selectpicker form-control form-control-sm border required"
									data-size="5" data-style="campo rounded select-sm bg-transparent">
								</select>
							</div>
							<div class="col-9">
								<label class="d-flex"><span id="lblnombre">Razón social del Cliente</span>
									<div class="ml-auto top-0">
										<div class="form-check form-check-inline">
											<label class="form-check-label" style="line-height: 0px;" for="activo">
												<input class="form-check-input" tabindex="-1" type="checkbox" id="activo" value="1">
												Activo
											</label>
										</div>
									</div>
								</label>
								<div class="form-inline" id="personaJuridica">
									<input type="text" id="rsocial" class="form-control form-control-sm col required campo"
										placeholder="Razón social" maxlength="255"
										oninput="if(this.value.length > this.maxlength) this.value = this.value.slice(0, this.maxlength);">
								</div>
								<div class="form-inline d-none" id="personaNatural">
									<input type="text" id="primernombre" class="form-control form-control-sm col-3 required campo"
										placeholder="Primer Nombre" maxlength="120"
										oninput="if(this.value.length > this.maxlength) this.value = this.value.slice(0, this.maxlength);">
									<input type="text" id="segundonombre" class="form-control form-control-sm col-3 campo"
										placeholder="Segundo Nombre" maxlength="120"
										oninput="if(this.value.length > this.maxlength) this.value = this.value.slice(0, this.maxlength);">
									<input type="text" id="primerapellido" class="form-control form-control-sm col-3 required campo"
										placeholder="Primer Apellido" maxlength="120"
										oninput="if(this.value.length > this.maxlength) this.value = this.value.slice(0, this.maxlength);">
									<input type="text" id="segundoapellido" class="form-control form-control-sm col-3 campo"
										placeholder="Segundo Apellido" maxlength="120"
										oninput="if(this.value.length > this.maxlength) this.value = this.value.slice(0, this.maxlength);">
									<span id="nombrefull" class="bg-warning col-12 d-none text-center border border-dark rounded"></span>
								</div>
							</div>
						</div>
					</div>
					<div class="row col-12">
						<div class="form-group col-2">
							<label for="fechanac">Fecha Nacimiento</label>
							<input id="fechanac" type="date" class="form-control form-control-sm required campo pr-1">
						</div>
						<div class="form-group col-10 text-nowrap">
							<table class="col" id="otrasopciones">
								<thead>
									<tr>
										<th colspan="2"><label>Tipo Cliente</label></th>
										<th>&emsp;</th>
										<th colspan="3"><label>Otras opciones del Cliente</label> <input type="hidden" id="otrosclte" value="0"></label></th>
										<th>&emsp;</th>									
										<th><label>Grupo</label></th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>
											<div class="form-check form-check-inline">
												<input class="form-check-input campo required" type="checkbox" name="tipoclte" id="cltevip" value="1"
													onchange="$('#clteong').prop('checked', false); calcularTipoC();">
												<label class="form-check-label" for="cltevip">VIP</label>
											</div>
										</td>
										<td>
											<div class="form-check form-check-inline">
												<input class="form-check-input campo required" type="checkbox" name="tipoclte" id="clteong" value="2"
													onchange="$('#cltevip').prop('checked', false); calcularTipoC();">
												<label class="form-check-label" for="clteong">ONG</label>
											</div>
										</td>
										<td></td>
										<td>
											<div class="form-check form-check-inline">
												<label class="form-check-label" for="mcredito">Maneja Crédito&nbsp;</label>
												<input class="form-check-input campo required" type="checkbox" id="mcredito" value="16" onchange="calcularTipoC()">
											</div>
										</td>
										<td>
											<div class="form-check form-check-inline">
												<label class="form-check-label" for="moferta">Maneja Oferta&nbsp;</label>
												<input class="form-check-input campo required" type="checkbox" id="moferta" value="8" onchange="calcularTipoC()">
											</div>
										</td>
										<td>
											<div class="form-check form-check-inline">
												<label class="form-check-label" for="miva">Maneja IVA&nbsp;</label>
												<input class="form-check-input campo required" type="checkbox" id="miva" value="4" onchange="calcularTipoC()">
											</div>
										</td>
										<td></td>
										<td>
											<select id="select_grpCltes" class="selectpicker form-control form-control-sm border"
												data-live-search="true" data-size="5" data-style="campo rounded select-sm bg-transparent required"
												data-live-search-placeholder="Nombre Parcial/Total del Grupo">
											</select>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="row col-12">
						<div class="form-group col-4">
							<label for="select_tributo">Tributo Receptor</label>
							<select id="select_tributo" class="selectpicker form-control form-control-sm border required"
								data-size="5" data-style="campo rounded select-sm bg-transparent" multiple>
							</select>
						</div>
						<div class="form-group col-4">
							<label for="select_obligacion">Oblig. Fiscales</label>
							<select id="select_obligacion" class="selectpicker form-control form-control-sm border required"
								data-size="5" data-style="campo rounded select-sm bg-transparent">
							</select>
						</div>
						<div class="form-group col-4">
							<label for="select_tiporegimen">Tipo Regimen</label>
							<select id="select_tiporegimen" class="selectpicker form-control form-control-sm border required"
								data-size="5" data-style="campo rounded select-sm bg-transparent">							
							</select>
						</div>
					</div>
					<div class="row col-12">
						<div class="form-group col-3">
							<label for="select_pais">País</label>
							<select id="select_pais" class="selectpicker form-control form-control-sm border required"
								data-live-search="true" data-size="5" data-style="campo rounded select-sm bg-transparent"
								data-live-search-placeholder="Nombre Parcial/Total del País">
							</select>
						</div>
						<div class="form-group col-3">
							<div class="datos-select">
								<label for="select_dptos">Departamento/Estado</label>
								<select id="select_dptos" class="selectpicker form-control form-control-sm border required"
									data-live-search="true" data-size="5" data-style="campo rounded select-sm bg-transparent"
									data-live-search-placeholder="Nombre Parcial/Total del Departamento">
								</select>
							</div>
							<div class="d-none datos-inputs">
								<label for="dptoedo">Departamento/Estado</label>
								<input type="text" id="dptoedo" class="form-control form-control-sm required"
									placeholder="Departamento/Estado" onkeyup="if(event.keyCode==13) $('#ciudad').focus()">
							</div>
						</div>
						<div class="form-group col-3">
							<div class="datos-select">
								<label for="select_ciudad">Ciudad</label>
								<select id="select_ciudad" class="selectpicker form-control form-control-sm border required"
									data-live-search="true" data-size="5" data-style="campo rounded select-sm bg-transparent"
									data-live-search-placeholder="Nombre Parcial/Total del Departamento">
								</select>
							</div>
							<div class="d-none datos-inputs">
								<label for="ciudad">Ciudad</label>
								<input type="text" id="ciudad" class="form-control form-control-sm required"
									placeholder="Ciudad" onkeyup="if(event.keyCode==13) $('#postal').focus()">
							</div>
							<input type="hidden" value="0" id="municipio">
						</div>
						<div class="form-group col-3">
							<div class="datos-select">
								<label for="select_postales">Código Postal</label>
								<select id="select_postales" class="selectpicker form-control form-control-sm border required"
									data-live-search="true" data-size="5" data-style="campo rounded select-sm bg-transparent"
									data-live-search-placeholder="Nombre Parcial/Total del Departamento">
								</select>
							</div>
							<div class="d-none datos-inputs">
								<label for="postal">Código Postal</label>
								<input type="text" id="postal" class="form-control form-control-sm required"
									placeholder="Codigo Postal"
									onkeyup="if(event.keyCode==13) { setTimeout(function() { $('#direccion').focus(); }, 50) }">
							</div>
						</div>
					</div>
					<div class="row col-12">
						<div class="form-group col-12">
							<label for="direccion">Dirección</label>
							<input id="direccion" class="campo form-control form-control-sm required" type="text" maxlength="150"
								oninput="if(this.value.length > this.maxlength) this.value = this.value.slice(0, this.maxlength);"
								placeholder="Dirección exacta del Cliente">
						</div>
					</div>
					<div class="row col-12">
						<div class="form-group col-3">
							<div class="form-group">
								<label for="emailclte">Correo Electrónico</label>
								<input type="email" class="campo form-control form-control-sm text-lowercase required" id="emailclte"				
									placeholder="Cliente@dominio.com">
							</div>
						</div>
						<div class="form-group col-3">
							<div class="form-group">
								<label for="telclte">Teléfono fijo</label>
								<input id="telclte" class="campo form-control form-control-sm required" type="text" placeholder="1234567">
							</div>
						</div>
						<div class="form-group col-2">
							<div class="form-group">
								<label for="telclte">Celular</label>
								<input id="celclte" class="campo form-control form-control-sm required" type="text" placeholder="3101234567">
							</div>
						</div>
						<div class="form-group col-2">
							<div class="form-group">
								<label for="diascredito">Días de Crédito</label>
								<input id="diascredito" class="campo form-control form-control-sm required" type="number" placeholder="30">
							</div>
						</div>
						<div class="form-group col-2">
							<div class="form-group">
								<label for="limite">Límite</label>
								<input id="limite" class="campo form-control form-control-sm" type="number" placeholder="123456.23">
							</div>
						</div>
					</div>
					<div class="row col-12">
						<div class="form-group col-4">
							<div class="form-group">
								<label for="nomcontacto">Nombre contacto</label>
								<input id="nomcontacto" class="campo form-control form-control-sm required" type="text" placeholder="Nombre/Referencia contacto">
							</div>
						</div>
						<div class="form-group col-3">
							<div class="form-group">
								<label for="emailcontacto">Correo Electrónico Contacto</label>
								<input type="email" class="campo form-control form-control-sm text-lowercase required" id="emailcontacto"
									placeholder="Cliente@dominio.com">
							</div>
						</div>
						<div class="form-group col-3">
							<div class="form-group">
								<label for="telcontacto">Teléfonos Contacto</label>
								<input id="telcontacto" class="campo form-control form-control-sm required" type="text" placeholder="3101234567">
							</div>
						</div>
					</div>
					<div class="row col-12">
						<div class="form-group col-12">
							<label for="observacion">Obervación</label>
							<textarea id="observacion" class="campo form-control form-control-sm" type="text" placeholder="Observaciones"></textarea>
						</div>
					</div>
				</div>
			</div>
			<div class="card-footer border-top border-secondary alert-primary p-1" id="botones">
				<div class="col-12">
					<div class="col-10 text-center p-0">
						<span class="badge badge-warning float-left p-2 elevation-2"><span class="border border-dark required bg-white rounded">&emsp;&emsp;</span> Estos datos son obligatorios</span>
						<button type="button" class="btn btn-sm btn-danger" id="btnCancelar"><i class="fas fa-times"></i> Cancelar</button>
						<button type="button" class="btn btn-sm btn-success" onclick="guardarCliente()"><i class="fas fa-save"></i> Guardar</button>
					</div>
				</div>
			</div>
			<!-- /.card-body -->
		</div>
	</div>
</div>

<script>
	var nuevo   = 0;
	var inicio  = 0;
	var codpais = 0;
	var coddpto = 0;
	var codmpio = '';

	if($('#codclteindex').val()=='') {
		$('#rowLista').removeClass('d-none');
		$('#rowDatos').addClass('d-none');
		redim();
		$('#buscarClte').focus();
	}
	
	$.ajax({
		url: "app/controller/registro_clientes.php",
		data: {
			opcion: "valoresIniciales",
		},
		type: "POST",
		dataType: "json",
		beforeSend: () => { if($('#codclteindex').val()!='') { cargando2('show') } },
		success : function(data) {
			let idfiscal        = data.idfiscal;
			let tipopersona     = data.tipopersona;
			let grpCltes        = data.grpCltes;
			let tributoreceptor = data.tributoreceptor;
			let obligfiscal     = data.obligfiscal;
			let tiporegimen     = data.tiporegimen;
			let dbPaises        = data.dbPaises;
			let dbDepartamentos = data.dbDepartamentos;

			for (i=0; i<idfiscal.length; i++) {
				$("#select_idfiscal").append(
					'<option value="'+ idfiscal[i].codigo +
					'" data-subtext="'+idfiscal[i].significado+'">' +
					idfiscal[i].abreviatura + '</option>');
			}
			for (i=0; i<tipopersona.length; i++) {
				$("#select_tipopersona").append(
					'<option value="'+ tipopersona[i].codigo + '">' +
						tipopersona[i].tipo + '</option>');
			}
			for (i=0; i<grpCltes.length; i++) {
				$("#select_grpCltes").append(
					'<option value="'+ grpCltes[i].ID + '">' +
						grpCltes[i].GRUPO + '</option>');
			}
			for (i=0; i<tributoreceptor.length; i++) {
				$("#select_tributo").append(
					'<option value="'+ tributoreceptor[i].id +
					'" data-subtext="'+tributoreceptor[i].descripcion+'">' +
					tributoreceptor[i].nombre + '</option>');
			}
			for (i=0; i<obligfiscal.length; i++) {
				$("#select_obligacion").append(
					'<option value="'+ obligfiscal[i].codigo + '">' +
						obligfiscal[i].significado + '</option>');
			}
			for (i=0; i<tiporegimen.length; i++) {
				$("#select_tiporegimen").append(
					'<option value="'+ tiporegimen[i].codigo + '">' +
						tiporegimen[i].significado + '</option>');
			}
			for (i=0; i<dbPaises.length; i++) {
				$("#select_pais").append(
					'<option value="'+ dbPaises[i].codigo +
					'">(' + dbPaises[i].alfa2 + ') ' +
					dbPaises[i].nombre + '</option>');
			}
			for (i=0; i<dbDepartamentos.length; i++) {
				$("#select_dptos").append(
					'<option value="'+ dbDepartamentos[i].codigo +
					'">(' + dbDepartamentos[i].codigo_iso + ') ' +
					dbDepartamentos[i].nombre + '</option>');
			}
		},
		complete: ()=>{ 
			$(document).ready(function () {
				$('#fechanac').attr('max', moment().format('YYYY-MM-DD'));
				$('#subtitulo').html('Nuevo');
				if($('#codclteindex').val()!='') {
					setTimeout(function() {
						editarCliente($('#codclteindex').val());
						$('#codclteindex').val([]);
						cargando2('show');
					}, 250);
				}
			});
			$('.selectpicker').selectpicker();
		}
	}).done(function() {
		$('#select_tipopersona').on("changed.bs.select", function() {
			if(this.value==2) {
				if(!$('#personaJuridica').hasClass('d-none')) {
					$('#personaJuridica').addClass('d-none')
				}
				$('#lblnombre').html('Nombres y Apellidos del Cliente')
				$('#personaNatural').removeClass('d-none');
				if($('#primernombre').val().trim()=='' && $('#primerapellido').val().trim()=='' && nuevo==0) {
					$('#nombrefull').html('Por favor ordene <span class="text-danger font-weight-bold">'+$('#rsocial').val().trim()+'</span> en los cuadros arriba');
					$('#nombrefull').removeClass('d-none');
				} else {
					$('#nombrefull').html('&nbsp;');
					if(!$('#nombrefull').hasClass('d-none')) {
						$('#nombrefull').addClass('d-none');
					}
				}
			} else {
				if(!$('#personaNatural').hasClass('d-none')) {
					$('#personaNatural').addClass('d-none')
				}
				$('#lblnombre').html('Razón social del Cliente')
				$('#personaJuridica').removeClass('d-none');
			}
		});
		$('#select_pais').on("changed.bs.select", function() {
			if(this.value==170) {
				$('.datos-select').removeClass('d-none');
				if(!$('.datos-inputs').hasClass('d-none')) {
					$('.datos-inputs').addClass('d-none');
				}
			} else {
				if(!$('.datos-select').hasClass('d-none')) {
					$('.datos-select').addClass('d-none');
				}
				$('.datos-inputs').removeClass('d-none');
			}
		});
		$('#select_dptos').on("changed.bs.select", function() {
			if($('#select_pais').val()==170) {
				selCiudad(this.value);
			}
		});
	});
	
	$(window).on('resize', function() {
		redim();
	});
	
	function redim() {
		if($('#div_ppal_rc').is(':visible')) {
			if(inicio==0) {
				inicio = 1;
				$('#lstClientesFacEle').DataTable().clear();
			}
			if($('#rowLista').is(':visible')) {
				let whrc = window.innerHeight;
				let ltrc = $('#lstClientesFacEle').offset().top;
				let dtrc = ($('#buscarClte').offset().top/4);
				let altoTablaDatosrc = (whrc-ltrc-dtrc);
				$('#lstClientesFacEle_wrapper .dataTables_scrollBody').height(altoTablaDatosrc);
			}
			if(!$('#rowDatos').hasClass('d-none')) {
				$('#div_datos').height( window.innerHeight-$('#div_datos').offset().top-$('#botones').height()-34 +'px')
			}
		}
	}
	
	if($('#rowLista').is(':visible')) {
		$('#buscarClte').on('focus', function() { $(this).select() });
	}

	$('#frmdatos').keyup(function(e) {
		if (e.which === 13) {
			if($(document.activeElement).hasClass('campo')) {
				var ind = $('.campo').index($(document.activeElement));
				$('.campo').eq(ind+1).focus()
			}
		}
    })
	
	$('#btnCancelar').on('click', function() {
		if($('#origenui').val()!=[]) {
			let cargar = $('#origenui').val()
			$('#origenui').val([])
			$('#'+cargar).modal('hide');
			$('#'+cargar).html('');
		} else {
			buscarCliente();
			nuevo   = 0;
			coddpto = 0;
			codmpio = '';
			$('#rowLista').removeClass('d-none');
			$('#rowDatos').addClass('d-none');
			limpiarInfo();
		}
	})

	function selCiudad(dpto, cdmpio='0')  {
		$.ajax({
			url: "app/controller/registro_clientes.php",
			data: {
				opcion: "dbMunicipios",
				idpara: dpto,

			},
			type: "POST",
			dataType: "json",
			beforeSend: function() {
				$('#select_ciudad').selectpicker('destroy');
				$('#select_ciudad').empty();
			},
			success : function(data) {
				selPostales($('#select_dptos').val(), data[0].codigo_mpio);
				$('#municipio').val(data[0].id)
				for (i=0; i<data.length; i++) {
					$("#select_ciudad").append('<option value="'+ data[i].codigo_mpio + '" data-mid="'+ data[i].id +'">(' + data[i].codigo_mpio + ') ' + data[i].nombre + '</option>');
				}
				if(cdmpio!='0') {
					$("#select_ciudad").selectpicker('val', cdmpio);
				}
			},
			complete: function() {
				$('#select_ciudad').selectpicker('refresh');
				$('#select_ciudad').on("changed.bs.select", function() {
					$('#municipio').val($('option:selected', this).attr("data-mid"));
					if(this.value!='' ) {
						selPostales(dpto, this.value);
					}
				});
			}
		});
	}
	
	function selPostales(dpto, mpio, post='0')  {
		$.ajax({
			url: "app/controller/registro_clientes.php",
			data: {
				opcion: "dbCodigosPostales",
				cddpto: dpto,
				cdmpio: mpio,

			},
			type: "POST",
			dataType: "json",
			beforeSend: function() {
				$('#select_postales').selectpicker('destroy');
				$('#select_postales').empty();
			},
			success : function(data) {
				for (i=0; i<data.length; i++) {
					$("#select_postales").append('<option value="'+ data[i].codigo_postal + '">(' + data[i].codigo_postal + ') ' + data[i].tipo + '</option>');
				}
			},
			complete: function() {
				$('#select_postales').selectpicker();
				if(post!='0') {
					$('#select_postales').selectpicker('val', post);
				}
			}
		});
	}

	function calcularTipoC() {
		var valor = 0;
		if($('#cltevip').is(':checked')) {
			valor += parseInt($('#cltevip').val());
		}
		if($('#clteong').is(':checked')) {
			valor += parseInt($('#clteong').val());
		}
		if($('#mcredito').is(':checked')) {
			valor += parseInt($('#mcredito').val());
		}
		if($('#moferta').is(':checked')) {
			valor += parseInt($('#moferta').val());
		}
		if($('#miva').is(':checked')) {
			valor += parseInt($('#miva').val());
		}

		$('#otrosclte').val(valor);
	}

	function extraeerTipoc(dato) {
		$('#otrosclte').val(dato);
		$('#cltevip').prop('checked', false);
		$('#clteong').prop('checked', false);
		$('#miva').prop('checked', false);
		$('#moferta').prop('checked', false);
		$('#mcredito').prop('checked', false);
		switch (dato) {
			case 4:
				$('#miva').prop('checked', true);
				break;
			
			case 5:
				$('#cltevip').prop('checked', true);
				$('#miva').prop('checked', true);
				break;
			
			case 8:
				$('#moferta').prop('checked', true);
				break;
			
			case 12:
				$('#moferta').prop('checked', true);
				$('#mmiva').prop('checked', true);
				break;

			case 16:
				$('#mcredito').prop('checked', true);
				break;
			
			case 17:
				$('#cltevip').prop('checked', true);
				$('#mcredito').prop('checked', true);
				break;

			case 18:
				$('#clteong').prop('checked', true);
				$('#mcredito').prop('checked', true);
				break;

			case 20:
				$('#mcredito').prop('checked', true);
				$('#miva').prop('checked', true);
				break;

			case 24:
				$('#mcredito').prop('checked', true);
				$('#moferta').prop('checked', true);
				break;
			
			case 25:
				$('#cltevip').prop('checked', true);
				$('#mcredito').prop('checked', true);
				$('#moferta').prop('checked', true);
				break;
			
			case 26:
				$('#clteong').prop('checked', true);
				$('#mcredito').prop('checked', true);
				$('#moferta').prop('checked', true);
				break;

			case 28:
				$('#mcredito').prop('checked', true);
				$('#moferta').prop('checked', true);
				$('#miva').prop('checked', true);
				break;			

			case 29:
				$('#cltevip').prop('checked', true);
				$('#mcredito').prop('checked', true);
				$('#moferta').prop('checked', true);
				$('#miva').prop('checked', true);
				break;

			case 30:
				$('#clteong').prop('checked', true);
				$('#mcredito').prop('checked', true);
				$('#moferta').prop('checked', true);
				$('#miva').prop('checked', true);
				break;

			default:
				break;
		}
	}

	function validarEmail(email) {
		emailRegex = /^[-\w.%+]{1,64}@(?:[A-Z0-9-]{1,63}\.){1,125}[A-Z]{2,63}$/i;
		//Se muestra un texto a modo de ejemplo, luego va a ser un icono
		return emailRegex.test(email)
	}

	function validar() {
		var errores = [];
		var focus = '';
		if($('#idclte').val().trim()=='' || $('#idclte').val().length < 5) {
			errores.push('Ingrese una <b>identificación</b> válida para el cliente');
			focus = focus==''?'idclte':focus;
		}
		if($('#select_tipopersona').val()==2) {
			if($('#primernombre').val().trim()=='' || $('#primernombre').val().length < 3) {
				errores.push('Ingrese un <b>nombre</b> válido para el cliente');
				focus = focus==''?'primernombre':focus;
			}
			if($('#primerapellido').val().trim()=='' || $('#primerapellido').val().length < 3) {
				errores.push('Ingrese un <b>apellido</b> válido para el cliente');
				focus = focus==''?'primerapellido':focus;
			}
		} else {
			if($('#rsocial').val().trim()=='' || $('#rsocial').val().length < 3){
				errores.push('Ingrese una <b>Razón social</b> válida para el cliente');
				focus = focus==''?'rsocial':focus;
			}
		}
		if($('#fechanac').val()=='') {
			errores.push('Ingrese una <b>fecha de nacimiento</b> válida para el cliente');
			focus = focus==''?'fechanac':focus;
		}
		if($('#otrosclte').val()==0) {
			errores.push('Indique una opción en <b>otras opciones</b> para el cliente');
			focus = focus==''?'mcredito':focus;
		}
		if($('#select_tributo').val().length==0) {
			errores.push('Indique el(los) tipo(s) de <b>Tributo Receptor</b> para el cliente');
			focus = focus==''?'select_tributo':focus;
		}
		if($('#select_pais').val() == null && $('#select_pais').val()==170) {
			errores.push('Indique el <b>Pais</b> para el cliente');
			focus = focus==''?'dptoedo':focus;
		}
		if($('#select_dptos').val() == null && $('#select_pais').val()==170) {
			errores.push('Indique el <b>Departamento/Estado</b> para el cliente');
			focus = focus==''?'dptoedo':focus;
		}
		if($('#select_ciudad').val() == null && $('#select_pais').val()==170) {
			errores.push('Indique el <b>Ciudad</b> para el cliente');
			focus = focus==''?'dptoedo':focus;
		}
		if($('#select_postales').val() == null && $('#select_pais').val()==170) {
			errores.push('Indique el <b>Código Postal</b> para el cliente');
			focus = focus==''?'dptoedo':focus;
		}
		if($('#select_pais').val()!=170 && $('#dptoedo').val().trim()=='') {
			errores.push('Indique el <b>Departamento/Estado</b> para el cliente');
			focus = focus==''?'dptoedo':focus;
		}
		if($('#select_pais').val()!=170 && $('#ciudad').val().trim()=='') {
			errores.push('Indique la <b>Ciudad</b> para el cliente');
			focus = focus==''?'ciudad':focus;
		}
		if($('#select_pais').val()!=170 && $('#postal').val().trim()=='') {
			errores.push('Indique el <b>Código Postal</b> para el cliente');
			focus = focus==''?'postal':focus;
		}
		if($('#direccion').val().trim()=='' || $('#direccion').val().length < 5) {
			errores.push('Ingrese una <b>dirección</b> válida para el cliente');
			focus = focus==''?'direccion':focus;
		}
		if(!validarEmail($('#emailclte').val())) {
			errores.push('Ingrese un <b>correo electrónico</b> válido para el cliente');
			focus = focus==''?'emailclte':focus;
		}
		if($('#telclte').val().trim()=='' || $('#telclte').val().length < 5) {
			errores.push('Ingrese un <b>teléfono</b> válido para el cliente');
			focus = focus==''?'telclte':focus;
		}
		if($('#celclte').val().trim()=='' || $('#celclte').val().length < 5) {
			errores.push('Ingrese un <b>número celular</b> válido para el cliente');
			focus = focus==''?'celclte':focus;
		}
		if($('#diascredito').val().trim()=='') {
			errores.push('Ingrese un valor para <b>días de crédito</b> para el cliente');
			focus = focus==''?'diascredito':focus;
		}
		if($('#nomcontacto').val().trim()=='' || $('#nomcontacto').val().length < 5) {
			errores.push('Ingrese un <b>nombre</b> válido para contacto');
			focus = focus==''?'nomcontacto':focus;
		}
		if(!validarEmail($('#emailcontacto').val())) {
			errores.push('Ingrese un <b>correo electrónico</b> válido para contacto');
			focus = focus==''?'emailcontacto':focus;
		}
		if($('#telcontacto').val().trim()=='' || $('#telcontacto').val().length < 5) {
			errores.push('Ingrese un <b>teléfono</b> válido para contacto');
			focus = focus==''?'telcontacto':focus;
		}
		if(errores.length>0) {
			var mensaje = ''
			errores.forEach(error => {
				mensaje += '<div class="w-100 text-left"><i class="fas fa-times text-danger"></i> ' + error + '</div>';
			});
			msg.fire({
				title: '!!! A T E N C I Ó N ¡¡¡',
				icon: 'error',
				html: 'Por favor corrija la siguiente información<br>'+mensaje,
				showCancelButton: false,
				onAfterClose: function() { $('#'+focus).focus(); }
			}).then((result) => {
				if (result.value) {
					return false;
				}
			})
		} else {
			return true;
		}
	}

	function buscarCliente() {
		if($('#buscarClte').val().trim()!='') {
			cargando('show');
			tomar_datos = $.ajax({
				url: "app/controller/registro_clientes.php",
				data: {
					opcion: "lstClientesFacEle",
					idpara: function() { return $('#buscarClte').val().trim() },
	
				},
				type: "POST",
				dataType: "json",
				success : function(data) {
					if(data.length>0) {
						let ht = $('#lstClientesFacEle_wrapper .dataTables_scrollBody').height();
						$('#lstClientesFacEle').dataTable( {
							scrollY: ht+'px',
							scrollCollapse: false,
							autoWidth: false,
							order: [ [1, 'asc'] ],
							data: data,
							columns: [
								{width: ' 5%', data: "codigo"  , sClass: "align-middle border border-top-0 border-bottom-0"},
								{width: '10%', data: "rif"     , sClass: "align-middle border border-top-0 border-bottom-0"},
								{width: '40%', data: "rsocial" ,  sClass: "align-middle border border-top-0 border-bottom-0"},
								{width: '10%', data: "telefono", sClass: "align-middle border border-top-0 border-bottom-0"},
								{width: '25%', data: "email"   , sClass: "align-middle border border-top-0 border-bottom-0"},
								{width: '10%', data: "opciones", sClass: "align-middle border border-top-0 border-bottom-0"},
							],
							initComplete: function(settings, json) {
								setTimeout(()=>$(this).DataTable().columns.adjust().draw(false), 100);
							}
						});
					} else {
						msg.fire({
							title: '!!! A T E N C I Ó N ¡¡¡',
							icon: 'info',
							html: 'No se encontraron registros para<br><b>>> ' + ($('#buscarClte').val()).toUpperCase() + ' <<</b>',
							showCancelButton: false,
							onAfterClose: function() { $('#buscarClte').focus() },
						})
					}
				},
				complete: function() {
					cargando('hide');
					$('#filtroBuscar').html(' ['+$('#buscarClte').val()+']')
					$('#buscarClte').val([]);
				}
			})
		} else {
			$('#buscarClte').focus();
		}
	}

	function editarCliente(codigo) {
		cargando2('show')
		$('#rowLista').addClass('d-none');
		$('#rowDatos').removeClass('d-none');
		consultarClte(codigo);
	}

	function consultarClte(codigo) {
		$.ajax({
			url: "app/controller/registro_clientes.php",
			data: {
				opcion: "consultarClte",
				idpara: codigo,

			},
			type: "POST",
			dataType: "json",
			beforeSend: ()=>{ limpiarInfo() },
			success : function(data) {
				nuevo   = 0;
				data    = data[0];
				codpais = data.pais*1;
				coddpto = data.estado*1;
				codmpio = data.municipio;
				extraeerTipoc(data.tipoc*1);
				var regex   = /(\d+)/g;
				var regtext = /[CCCENIT]/gi;
				$('#codigoclte').val(data.codigo);
				$('#subtitulo').html('Editar Cliente Cod:[' + data.codigo + '] -- RIF:[' + data.rif +
					(data.digitoverificacion!=null?data.digitoverificacion:'') + ']');
				
				$('#select_idfiscal option').filter(function(){
					var str = (data.rif).match(regtext)
					if(str!=null) {
						return $.trim($(this).text()) == str.join('')
					}
				}).prop('selected', true);
				$('#select_idfiscal').selectpicker('refresh');

				$('#idclte').val((data.rif).match(regex));
				$('#codverif').val(data.digitoverificacion);
				$('#activo').prop('checked', data.activo==1);
				$('#rsocial').val(data.rsocial);
				$('#primernombre').val((data.pnombre).trim());
				$('#segundonombre').val((data.snombre).trim());
				$('#primerapellido').val((data.papellido).trim());
				$('#segundoapellido').val((data.sapellido).trim());
				if(data.pnombre=='' && data.papellido=='' && data.tipopersona==2) {
					$('#nombrefull').html('Por favor ordene <span class="text-danger font-weight-bold">'+data.rsocial+'</span> en los cuadros arriba');
					$('#nombrefull').removeClass('d-none');
				} else {
					$('#nombrefull').html('&nbsp;');
					if(!$('#nombrefull').hasClass('d-none')) {
						$('#nombrefull').addClass('d-none');
					}
				}
				$('#fechanac').val(data.fechanac!=null?moment(data.fechanac).format('YYYY-MM-DD'):[]);
				
				$('#select_grpCltes').selectpicker('val', data.grupo);
				$('#select_tributo').selectpicker('val', (data.tributoreceptor).split(','));
				$('#select_tipopersona').selectpicker('val', data.tipopersona);
				$('#select_obligacion').selectpicker('val', data.obligacionesfiscales);
				$('#select_tiporegimen').selectpicker('val', data.tiporegimen);
				$('#select_pais').selectpicker('val', codpais);
				$('#select_dptos').selectpicker('val', coddpto);
				
				if(codpais==170) {
					if(!$('.datos-inputs').hasClass('d-none')) {
						$('.datos-inputs').addClass('d-none');
					}
					$('.datos-select').removeClass('d-none');
				} else {
					if(!$('.datos-select').hasClass('d-none')) {
						$('.datos-select').addClass('d-none');
					}
					$('.datos-inputs').removeClass('d-none');
				}
				
				$('#dptoedo').val(data.otro_departamento);
				$('#ciudad').val(data.otro_ciudad);
				$('#postal').val(data.codigopostal);
				$('#municipio').val(data.ciudad);
				$('#direccion').val(data.direccion);
				$('#emailclte').val(data.email);
				$('#telclte').val(data.telefono);
				$('#celclte').val(data.telefonomovil);
				$('#diascredito').val(data.diascredito);
				$('#limite').val(data.limite);
				$('#nomcontacto').val(data.contacto);
				$('#emailcontacto').val(data.emailcontacto);
				$('#telcontacto').val(data.telefonocontacto);
				$('#observacion').val(data.observacion);

				$('#select_idfiscal').selectpicker('refresh');
				$('#select_tipopersona').selectpicker('refresh');
				$('#select_grpCltes').selectpicker('refresh');
				$('#select_tributo').selectpicker('refresh');
				$('#select_obligacion').selectpicker('refresh');
				$('#select_tiporegimen').selectpicker('refresh');
				$('#select_pais').selectpicker('refresh');
				$('#select_dptos').selectpicker('refresh');
				$('#select_ciudad').selectpicker('refresh');
				$('#select_postales').selectpicker('refresh');
			},
			complete: function() {
				$('#select_idfiscal').focus();
				if(codpais==170) {
					selCiudad(coddpto, codmpio);
					selPostales(coddpto, codmpio, $('#postal').val())
				}
				cargando2('hide')
			}
		})
	}

	function guardarCliente() {
		if(validar()){
			var datos = new FormData();
			datos.append( 'opcion'             , (nuevo==1)?'guardarClte':'actualizaClte' );
			datos.append( 'codigoclte'         , $('#codigoclte').val() );
			datos.append( 'activo'             , ($('#activo').prop('checked'))?1:0 );
			datos.append( 'idfiscal'           , $('#select_idfiscal').val() );
			datos.append( 'txtidfiscal'        , $("#select_idfiscal option:selected").text() );
			datos.append( 'idclte'             , $('#idclte').val() );
			datos.append( 'codverif'           , $('#codverif').val() );
			datos.append( 'rsocial'            , $('#rsocial').val().trim().toUpperCase() );
			datos.append( 'primernombre'       , $('#primernombre').val().trim().toUpperCase() );
			datos.append( 'segundonombre'      , $('#segundonombre').val().trim().toUpperCase() );
			datos.append( 'primerapellido'     , $('#primerapellido').val().trim().toUpperCase() );
			datos.append( 'segundoapellido'    , $('#segundoapellido').val().trim().toUpperCase() );
			datos.append( 'fechanac'           , $('#fechanac').val() );
			datos.append( 'otrosclte'          , $('#otrosclte').val() );
			datos.append( 'grpCltes'           , $('#select_grpCltes').val() );
			datos.append( 'tributo'            , $('#select_tributo').val() );
			datos.append( 'tipopersona'        , $('#select_tipopersona').val() );
			datos.append( 'obligacion'         , $('#select_obligacion').val() );
			datos.append( 'tiporegimen'        , $('#select_tiporegimen').val() );
			datos.append( 'pais'               , $('#select_pais').val() );
			datos.append( 'dptos'              , ($('#select_pais').val()==170)?$('#select_dptos').val():0 );
			datos.append( 'otro_dpto'          , ($('#select_pais').val()==170)?'':$('#dptoedo').val().trim() );
			datos.append( 'ciudad'             , ($('#select_pais').val()==170)?$('#municipio').val():0 );
			datos.append( 'otro_ciudad'        , ($('#select_pais').val()==170)?'':$('#ciudad').val().trim() );
			datos.append( 'municipio'          , ($('#select_pais').val()==170)?$('#select_ciudad').val():'' );
			datos.append( 'postales'           , ($('#select_pais').val()==170)?$('#select_postales').val():$('#postal').val() );
			datos.append( 'direccion'          , $('#direccion').val().trim().toUpperCase() );
			datos.append( 'emailclte'          , $('#emailclte').val().trim().toUpperCase() );
			datos.append( 'telclte'            , $('#telclte').val().trim().toUpperCase() );
			datos.append( 'celclte'            , $('#celclte').val().trim().toUpperCase() );
			datos.append( 'diascredito'        , ($('#diascredito').val()=='')?0:$('#diascredito').val() );
			datos.append( 'limite'             , ($('#limite').val()=='')?0:$('#limite').val() );
			datos.append( 'nomcontacto'        , $('#nomcontacto').val().trim().toUpperCase() );
			datos.append( 'emailcontacto'      , $('#emailcontacto').val().trim().toUpperCase() );
			datos.append( 'telcontacto'        , $('#telcontacto').val().trim().toUpperCase() );
			datos.append( 'observacion'        , $('#observacion').val().trim().toUpperCase() );
			$.ajax({
				url: "app/controller/registro_clientes.php",
				contentType:false,
				processData:false,
				cache:false,
				data: datos,
				type: "POST",
				dataType: "json",
				success : function(data) {
					msg.fire({
						title: '!!! A T E N C I Ó N ¡¡¡',
						icon: data.status==1 ? 'success' : 'error',
						html: data.mensaje+'<br>'+data.query,
						showCancelButton: false,
						onAfterClose: function() {
							if(data.status==1) {
								$('#btnCancelar').click();
							}
						}
					})
				},
				
			});
		}
	}

	function limpiarInfo() {
		if(!$('#nombrefull').hasClass('d-none')) { $('#nombrefull').addClass('d-none'); }
		if(!$('.datos-inputs').hasClass('d-none')) { $('.datos-inputs').addClass('d-none'); }
		$('.datos-select').removeClass('d-none');

		$('#codigoclte').val([]);
		$('#subtitulo').html('Nuevo');
		$('#activo').prop('checked', nuevo==1);
		$('#rsocial').val([]);
		$('#primernombre').val([]);
		$('#segundonombre').val([]);
		$('#primerapellido').val([]);
		$('#segundoapellido').val([]);
		$('#nombrefull').html('')
		$('#fechanac').val([]);
		$('#idclte').val([]);
		$('#codverif').val([]);

		$('#dptoedo').val([]);
		$('#ciudad').val([]);
		$('#postal').val([]);
		$('#municipio').val([]);
		$('#direccion').val([]);
		$('#emailclte').val([]);
		$('#telclte').val([]);
		$('#celclte').val([]);
		$('#diascredito').val([]);
		$('#limite').val([]);
		$('#nomcontacto').val([]);
		$('#emailcontacto').val([]);
		$('#telcontacto').val([]);
		$('#observacion').val([]);

		$('#select_idfiscal').val($("#select_idfiscal option:first").val());
		$('#select_tipopersona').val($("#select_tipopersona option:first").val());
		$('#select_grpCltes').val($("#select_grpCltes option:first").val());
		$('#select_tributo').selectpicker('val', []);
		$('#select_obligacion').val($("#select_obligacion option:first").val());
		$('#select_tiporegimen').val($("#select_tiporegimen option:first").val());
		$('#select_pais').val($("#select_pais option:first").val());
		$('#select_ciudad').empty();
		$('#select_postales').empty();
		$('#select_dptos').selectpicker('val', $("#select_dptos option:first").val());
		
		$('#select_idfiscal').selectpicker('refresh');
		$('#select_tipopersona').selectpicker('refresh');
		$('#select_grpCltes').selectpicker('refresh');
		$('#select_tributo').selectpicker('refresh');
		$('#select_obligacion').selectpicker('refresh');
		$('#select_tiporegimen').selectpicker('refresh');
		$('#select_pais').selectpicker('refresh');
		$('#select_dptos').selectpicker('refresh');
		$('#select_ciudad').selectpicker('refresh');
		$('#select_postales').selectpicker('refresh');

		setTimeout("redim()", 150);
	}

	function nuevoCliente() {
		nuevo = 1;
		$('#rowLista').addClass('d-none');
		$('#rowDatos').removeClass('d-none');
		limpiarInfo();
	}

	function bloquearCliente(codigo) {
		$.ajax({
			url: "app/controller/registro_clientes.php",
			data: {
				opcion: "bloquearCliente",
				idpara: codigo,
			},
			type: "POST",
			dataType: "json",
			success : function(data) {
				if(data.status==0) {
					msg.fire({
						title: '!!! A T E N C I Ó N ¡¡¡',
						icon: 'error',
						html: data.mensaje + '<br>' + data.query,
						showCancelButton: false,
					})
				}
				buscarCliente()
			}
		});
	}
</script>